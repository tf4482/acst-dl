{% extends "base.html" %}

{% block title %}Dashboard - ACST-DL{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <!-- Page Header -->
    <div class="border-b border-gray-200 pb-5 mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg leading-6 font-medium text-gray-900">
                    <i class="fas fa-tachometer-alt text-primary-500 mr-2"></i>
                    Dashboard
                </h3>
                <p class="mt-2 max-w-4xl text-sm text-gray-500">
                    Monitor your podcast downloads and manage your configuration
                </p>
            </div>
            <div class="flex space-x-3">
                <button id="refresh-btn" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Refresh
                </button>
                <button id="clear-files-btn" class="inline-flex items-center px-3 py-2 border border-red-300 shadow-sm text-sm leading-4 font-medium rounded-md text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    <i class="fas fa-trash mr-2"></i>
                    Clear All Files
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-8">
        <!-- Total URLs -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-link text-2xl text-blue-500"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">
                                Configured URLs
                            </dt>
                            <dd class="text-lg font-medium text-gray-900">
                                {{ config.urls|length }}
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Sessions -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-history text-2xl text-green-500"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">
                                Recent Sessions
                            </dt>
                            <dd class="text-lg font-medium text-gray-900">
                                {{ sessions|length }}
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Downloads -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-download text-2xl text-yellow-500"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">
                                Active Downloads
                            </dt>
                            <dd class="text-lg font-medium text-gray-900" id="active-downloads-count">
                                {{ sessions|selectattr("status", "equalto", "running")|list|length }}
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Success Rate -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-check-circle text-2xl text-green-600"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">
                                Success Rate
                            </dt>
                            <dd class="text-lg font-medium text-gray-900">
                                {% set completed = sessions|selectattr("status", "equalto", "completed")|list|length %}
                                {% set total = sessions|length %}
                                {% if total > 0 %}
                                    {{ "%.0f"|format((completed / total) * 100) }}%
                                {% else %}
                                    N/A
                                {% endif %}
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Configuration Preview -->
    <div class="bg-white shadow rounded-lg mb-8">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                <i class="fas fa-cog text-primary-500 mr-2"></i>
                Current Configuration
            </h3>
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
                <div>
                    <dt class="text-sm font-medium text-gray-500">Timeout</dt>
                    <dd class="mt-1 text-sm text-gray-900">{{ config.timeout }} seconds</dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500">Max MP3 Links</dt>
                    <dd class="mt-1 text-sm text-gray-900">
                        {% if config.max_mp3_links %}{{ config.max_mp3_links }}{% else %}Unlimited{% endif %}
                    </dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500">Download MP3 Files</dt>
                    <dd class="mt-1 text-sm text-gray-900">
                        {% if config.download_mp3_files %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                <i class="fas fa-check mr-1"></i>Enabled
                            </span>
                        {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                <i class="fas fa-times mr-1"></i>Disabled
                            </span>
                        {% endif %}
                    </dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500">SSL Verification</dt>
                    <dd class="mt-1 text-sm text-gray-900">
                        {% if config.verify_ssl %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                <i class="fas fa-shield-alt mr-1"></i>Enabled
                            </span>
                        {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                <i class="fas fa-shield-alt mr-1"></i>Disabled
                            </span>
                        {% endif %}
                    </dd>
                </div>
                <div class="sm:col-span-2 lg:col-span-1">
                    <dt class="text-sm font-medium text-gray-500">Configured URLs</dt>
                    <dd class="mt-1 text-sm text-gray-900">{{ config.urls|length }} podcast feeds</dd>
                </div>
            </div>
            <div class="mt-4">
                <a href="/config" class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-primary-700 bg-primary-100 hover:bg-primary-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                    <i class="fas fa-edit mr-2"></i>
                    Edit Configuration
                </a>
            </div>
        </div>
    </div>

    <!-- Scheduler Status -->
    <div class="bg-white shadow rounded-lg mb-8">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900">
                    <i class="fas fa-clock text-primary-500 mr-2"></i>
                    Automatic Download Scheduler
                </h3>
                <div class="flex space-x-3">
                    <button id="scheduler-toggle-btn" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <i class="fas fa-play mr-2"></i>
                        <span id="scheduler-toggle-text">Start</span>
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                <div>
                    <dt class="text-sm font-medium text-gray-500">Status</dt>
                    <dd class="mt-1 text-sm text-gray-900">
                        <span id="scheduler-status-badge" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                            <i class="fas fa-pause-circle mr-1"></i>Disabled
                        </span>
                    </dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500">Interval</dt>
                    <dd id="scheduler-interval-display" class="mt-1 text-sm text-gray-900">60 minutes</dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500">Next Run</dt>
                    <dd id="scheduler-next-run" class="mt-1 text-sm text-gray-900">Not scheduled</dd>
                </div>
            </div>
            
            <div class="mt-4">
                <p id="scheduler-last-run" class="text-sm text-gray-500">No previous runs</p>
            </div>
        </div>
    </div>

    <!-- Recent Download Sessions -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900">
                    <i class="fas fa-history text-primary-500 mr-2"></i>
                    Recent Download Sessions
                </h3>
                <button id="refresh-sessions-btn" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Refresh
                </button>
            </div>
            
            <div id="sessions-container">
                {% if sessions %}
                    <div class="space-y-4">
                        {% for session in sessions %}
                            <div class="session-card border border-gray-200 rounded-lg p-4" data-session-id="{{ session.id }}">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="flex-shrink-0">
                                            {% if session.status == 'completed' %}
                                                <i class="fas fa-check-circle text-green-500 text-xl"></i>
                                            {% elif session.status == 'running' %}
                                                <i class="fas fa-spinner fa-spin text-blue-500 text-xl"></i>
                                            {% elif session.status == 'failed' %}
                                                <i class="fas fa-exclamation-circle text-red-500 text-xl"></i>
                                            {% else %}
                                                <i class="fas fa-clock text-gray-400 text-xl"></i>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <p class="text-sm font-medium text-gray-900">
                                                Session {{ session.id[:8] }}
                                                {% if session.current_url %}
                                                    - Processing: {{ session.current_url }}
                                                {% endif %}
                                            </p>
                                            <p class="text-sm text-gray-500">
                                                Started: {{ session.created_at[:19] | replace('T', ' ') }}
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-4">
                                        <div class="text-right">
                                            <p class="text-sm font-medium text-gray-900">
                                                {{ session.completed_urls }}/{{ session.total_urls }} URLs
                                            </p>
                                            <p class="text-sm text-gray-500">
                                                {{ session.mp3_stats.downloaded }} MP3s downloaded
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                {% if session.error %}
                                    <div class="mt-3 p-3 bg-red-50 border border-red-200 rounded-md">
                                        <p class="text-sm text-red-700">
                                            <i class="fas fa-exclamation-triangle mr-2"></i>
                                            {{ session.error }}
                                        </p>
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-8">
                        <i class="fas fa-download text-gray-400 text-4xl mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No download sessions yet</h3>
                        <p class="text-gray-500 mb-4">Start your first download to see session history here.</p>
                        <button id="start-first-download" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                            <i class="fas fa-download mr-2"></i>
                            Start Download
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Handle session updates from WebSocket
    function handleSessionUpdate(session) {
        const sessionCard = document.querySelector(`[data-session-id="${session.id}"]`);
        if (sessionCard) {
            updateSessionCard(sessionCard, session);
        } else {
            // Add new session card if it doesn't exist
            addNewSessionCard(session);
        }
        
        // Update stats
        updateStats();
    }

    function updateSessionCard(card, session) {
        console.log('Updating session card:', session.id, 'Status:', session.status);
        
        // Update status icon
        const icon = card.querySelector('.fas');
        if (icon) {
            icon.className = 'fas text-xl ' + getStatusIcon(session.status);
        }
        
        // Update current URL
        const titleElement = card.querySelector('.text-sm.font-medium.text-gray-900');
        if (titleElement) {
            let title = `Session ${session.id.substring(0, 8)}`;
            if (session.current_url) {
                title += ` - Processing: ${session.current_url}`;
            }
            titleElement.textContent = title;
        }
        
        // Update counts
        const urlsCount = card.querySelector('.text-right .text-sm.font-medium');
        const mp3Count = card.querySelector('.text-right .text-sm.text-gray-500');
        if (urlsCount) {
            urlsCount.textContent = `${session.completed_urls}/${session.total_urls} URLs`;
        }
        if (mp3Count) {
            mp3Count.textContent = `${session.mp3_stats.downloaded} MP3s downloaded`;
        }
    }

    function getStatusIcon(status) {
        switch (status) {
            case 'completed': return 'fa-check-circle text-green-500';
            case 'running': return 'fa-spinner fa-spin text-blue-500';
            case 'failed': return 'fa-exclamation-circle text-red-500';
            default: return 'fa-clock text-gray-400';
        }
    }

    function addNewSessionCard(session) {
        const container = document.getElementById('sessions-container');
        const emptyState = container.querySelector('.text-center.py-8');
        if (emptyState) {
            emptyState.remove();
        }
        
        // Create sessions space if it doesn't exist
        let sessionsSpace = container.querySelector('.space-y-4');
        if (!sessionsSpace) {
            sessionsSpace = document.createElement('div');
            sessionsSpace.className = 'space-y-4';
            container.appendChild(sessionsSpace);
        }
        
        // Add new session card at the top
        const cardHTML = createSessionCardHTML(session);
        sessionsSpace.insertAdjacentHTML('afterbegin', cardHTML);
    }

    function createSessionCardHTML(session) {
        const statusIcon = getStatusIcon(session.status);
        
        return `
            <div class="session-card border border-gray-200 rounded-lg p-4" data-session-id="${session.id}">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            <i class="fas ${statusIcon} text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">
                                Session ${session.id.substring(0, 8)}
                                ${session.current_url ? `- Processing: ${session.current_url}` : ''}
                            </p>
                            <p class="text-sm text-gray-500">
                                Started: ${session.created_at.substring(0, 19).replace('T', ' ')}
                            </p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <p class="text-sm font-medium text-gray-900">
                                ${session.completed_urls}/${session.total_urls} URLs
                            </p>
                            <p class="text-sm text-gray-500">
                                ${session.mp3_stats.downloaded} MP3s downloaded
                            </p>
                        </div>
                    </div>
                </div>
                ${session.error ? `
                    <div class="mt-3 p-3 bg-red-50 border border-red-200 rounded-md">
                        <p class="text-sm text-red-700">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            ${session.error}
                        </p>
                    </div>
                ` : ''}
            </div>
        `;
    }

    function updateStats() {
        // This would update the stats cards with current data
        // For now, we'll just update the active downloads count
        const runningCount = document.querySelectorAll('[data-session-id]').length;
        const activeElement = document.getElementById('active-downloads-count');
        if (activeElement) {
            const runningSessions = document.querySelectorAll('.fa-spinner.fa-spin').length;
            activeElement.textContent = runningSessions;
        }
    }

    // Refresh functionality
    document.getElementById('refresh-btn').addEventListener('click', function() {
        location.reload();
    });

    document.getElementById('refresh-sessions-btn').addEventListener('click', async function() {
        try {
            const response = await fetch('/download/sessions');
            const data = await response.json();
            
            // Update sessions display
            const container = document.getElementById('sessions-container');
            container.innerHTML = '';
            
            if (data.sessions.length > 0) {
                const sessionsSpace = document.createElement('div');
                sessionsSpace.className = 'space-y-4';
                data.sessions.forEach(session => {
                    sessionsSpace.insertAdjacentHTML('beforeend', createSessionCardHTML(session));
                });
                container.appendChild(sessionsSpace);
            } else {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-download text-gray-400 text-4xl mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No download sessions yet</h3>
                        <p class="text-gray-500 mb-4">Start your first download to see session history here.</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error refreshing sessions:', error);
            showToast('Error refreshing sessions', 'error');
        }
    });

    // Clear files functionality
    document.getElementById('clear-files-btn').addEventListener('click', async function() {
        if (!confirm('Are you sure you want to clear all downloaded MP3 files? This action cannot be undone.')) {
            return;
        }
        
        const btn = this;
        const originalText = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Clearing...';
        
        try {
            const response = await fetch('/files/clear', {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast(`Cleared ${data.cleared_count} MP3 files`, 'success');
            } else {
                showToast('Failed to clear files', 'error');
            }
        } catch (error) {
            console.error('Error clearing files:', error);
            showToast('Error clearing files', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });

    // Start first download button
    const startFirstBtn = document.getElementById('start-first-download');
    if (startFirstBtn) {
        startFirstBtn.addEventListener('click', function() {
            document.getElementById('start-download-btn').click();
        });
    }

    // Handle live config updates
    function handleConfigUpdate(config) {
        // Update configuration preview section
        const configSection = document.querySelector('.bg-white.shadow.rounded-lg');
        if (configSection) {
            // Update timeout
            const timeoutElement = configSection.querySelector('dd');
            if (timeoutElement && timeoutElement.textContent.includes('seconds')) {
                timeoutElement.textContent = config.timeout + ' seconds';
            }
            
            // Update max MP3 links
            const maxLinksElements = configSection.querySelectorAll('dd');
            if (maxLinksElements[1]) {
                maxLinksElements[1].textContent = config.max_mp3_links ? config.max_mp3_links : 'Unlimited';
            }
            
            // Update download MP3 files status
            const downloadStatusElement = maxLinksElements[2];
            if (downloadStatusElement) {
                const isEnabled = config.download_mp3_files;
                downloadStatusElement.innerHTML = isEnabled ?
                    '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"><i class="fas fa-check mr-1"></i>Enabled</span>' :
                    '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800"><i class="fas fa-times mr-1"></i>Disabled</span>';
            }
            
            // Update SSL verification status
            const sslStatusElement = maxLinksElements[3];
            if (sslStatusElement) {
                const isEnabled = config.verify_ssl;
                sslStatusElement.innerHTML = isEnabled ?
                    '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"><i class="fas fa-shield-alt mr-1"></i>Enabled</span>' :
                    '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800"><i class="fas fa-shield-alt mr-1"></i>Disabled</span>';
            }
            
            // Update configured URLs count
            const urlsCountElement = maxLinksElements[4];
            if (urlsCountElement) {
                urlsCountElement.textContent = Object.keys(config.urls).length + ' podcast feeds';
            }
        }
        
        // Update stats card for configured URLs
        const urlsStatsCard = document.querySelector('.grid.grid-cols-1.gap-5.sm\\:grid-cols-2.lg\\:grid-cols-4 .bg-white:first-child dd');
        if (urlsStatsCard) {
            urlsStatsCard.textContent = Object.keys(config.urls).length;
        }
    }

    // Handle live session updates for dashboard statistics
    function handleSessionUpdate(session) {
        const sessionCard = document.querySelector(`[data-session-id="${session.id}"]`);
        if (sessionCard) {
            updateSessionCard(sessionCard, session);
        } else {
            // Add new session card if it doesn't exist
            addNewSessionCard(session);
        }
        
        // Update dashboard statistics
        updateDashboardStats();
    }

    // Update dashboard statistics cards
    function updateDashboardStats() {
        // Get all session cards
        const sessionCards = document.querySelectorAll('[data-session-id]');
        const totalSessions = sessionCards.length;
        
        // Count sessions by status
        let completedSessions = 0;
        let runningSessions = 0;
        
        sessionCards.forEach(card => {
            const icon = card.querySelector('.fas');
            if (icon.classList.contains('fa-check-circle')) {
                completedSessions++;
            } else if (icon.classList.contains('fa-spinner')) {
                runningSessions++;
            }
        });
        
        // Update stats cards
        const statsCards = document.querySelectorAll('.grid.grid-cols-1.gap-5.sm\\:grid-cols-2.lg\\:grid-cols-4 .bg-white');
        
        // Update Recent Sessions count (second card)
        if (statsCards[1]) {
            const recentSessionsCount = statsCards[1].querySelector('dd');
            if (recentSessionsCount) {
                recentSessionsCount.textContent = totalSessions;
            }
        }
        
        // Update Active Downloads count (third card)
        if (statsCards[2]) {
            const activeDownloadsCount = statsCards[2].querySelector('dd');
            if (activeDownloadsCount) {
                activeDownloadsCount.textContent = runningSessions;
            }
        }
        
        // Update Success Rate (fourth card)
        if (statsCards[3]) {
            const successRateElement = statsCards[3].querySelector('dd');
            if (successRateElement && totalSessions > 0) {
                const successRate = Math.round((completedSessions / totalSessions) * 100);
                successRateElement.textContent = successRate + '%';
            } else if (successRateElement) {
                successRateElement.textContent = 'N/A';
            }
        }
    }

    // Handle live sessions list updates
    function handleSessionsUpdate(sessions) {
        const sessionsContainer = document.getElementById('sessions-container');
        if (!sessionsContainer) return;

        if (sessions.length > 0) {
            // Rebuild sessions list
            let html = '<div class="space-y-4">';
            
            sessions.slice(0, 10).forEach(session => {
                html += createSessionCardHTML(session);
            });
            
            html += '</div>';
            sessionsContainer.innerHTML = html;
        } else {
            // Show empty state
            sessionsContainer.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-download text-gray-400 text-4xl mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No download sessions yet</h3>
                    <p class="text-gray-500 mb-4">Start your first download to see session history here.</p>
                    <button id="start-first-download" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <i class="fas fa-download mr-2"></i>
                        Start Download
                    </button>
                </div>
            `;
            
            // Re-attach event listener for start first download button
            const startFirstBtn = document.getElementById('start-first-download');
            if (startFirstBtn) {
                startFirstBtn.addEventListener('click', function() {
                    document.getElementById('start-download-btn').click();
                });
            }
        }
        
        // Update dashboard statistics
        updateDashboardStats();
    }

    // Handle scheduler updates
    function handleSchedulerUpdate(scheduler) {
        updateSchedulerStatus(scheduler);
    }

    function updateSchedulerStatus(scheduler) {
        const statusBadge = document.getElementById('scheduler-status-badge');
        const intervalDisplay = document.getElementById('scheduler-interval-display');
        const nextRunDisplay = document.getElementById('scheduler-next-run');
        const lastRunDisplay = document.getElementById('scheduler-last-run');
        const toggleBtn = document.getElementById('scheduler-toggle-btn');
        const toggleText = document.getElementById('scheduler-toggle-text');
        const toggleIcon = toggleBtn.querySelector('.fas');

        if (scheduler.enabled) {
            statusBadge.innerHTML = '<i class="fas fa-play-circle mr-1"></i>Active';
            statusBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
            
            toggleText.textContent = 'Stop';
            toggleIcon.className = 'fas fa-stop mr-2';
            toggleBtn.className = 'inline-flex items-center px-3 py-2 border border-red-300 shadow-sm text-sm leading-4 font-medium rounded-md text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500';
        } else {
            statusBadge.innerHTML = '<i class="fas fa-pause-circle mr-1"></i>Disabled';
            statusBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800';
            
            toggleText.textContent = 'Start';
            toggleIcon.className = 'fas fa-play mr-2';
            toggleBtn.className = 'inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500';
        }

        intervalDisplay.textContent = `${scheduler.interval_minutes} minutes`;

        if (scheduler.next_run) {
            const nextRun = new Date(scheduler.next_run);
            nextRunDisplay.textContent = nextRun.toLocaleString();
        } else {
            nextRunDisplay.textContent = 'Not scheduled';
        }

        if (scheduler.last_run) {
            const lastRun = new Date(scheduler.last_run);
            lastRunDisplay.textContent = `Last run: ${lastRun.toLocaleString()}`;
        } else {
            lastRunDisplay.textContent = 'No previous runs';
        }
    }

    // Scheduler toggle functionality
    document.getElementById('scheduler-toggle-btn').addEventListener('click', async function() {
        const btn = this;
        const toggleText = document.getElementById('scheduler-toggle-text');
        const originalText = toggleText.textContent;
        const isCurrentlyEnabled = originalText === 'Stop';
        
        btn.disabled = true;
        toggleText.textContent = isCurrentlyEnabled ? 'Stopping...' : 'Starting...';
        
        try {
            const endpoint = isCurrentlyEnabled ? '/scheduler/stop' : '/scheduler/start';
            const formData = new FormData();
            if (!isCurrentlyEnabled) {
                // Use current config interval or default to 60 minutes
                const currentInterval = document.getElementById('scheduler-interval-display').textContent.match(/\d+/);
                formData.append('interval_minutes', currentInterval ? currentInterval[0] : '60');
            }
            
            const response = await fetch(endpoint, {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast(data.message, 'success');
            } else {
                showToast('Failed to toggle scheduler', 'error');
            }
        } catch (error) {
            console.error('Error toggling scheduler:', error);
            showToast('Error toggling scheduler', 'error');
        } finally {
            btn.disabled = false;
            // Status will be updated via WebSocket, so we don't need to manually update here
        }
    });

    // Initial scheduler status
    {% if scheduler %}
        updateSchedulerStatus({{ scheduler | tojson }});
    {% endif %}
</script>
{% endblock %}
